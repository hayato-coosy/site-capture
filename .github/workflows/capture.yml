name: Capture & Publish

on:
  workflow_dispatch:
    inputs:
      start_urls:            # 1
        description: "開始URL（カンマ区切り可）"
        required: true
      devices:               # 2
        description: "デバイス/解像度（例: 'Desktop 1440x900,iPhone 13,375x812'）"
        required: false
        default: "Desktop 1440x900,iPhone 13"
      filename_mode:         # 3
        description: "保存方式: flat=フラット / tree=ディレクトリ構造保持"
        required: false
        default: "flat"
      scale:                 # 4
        description: "解像度スケール（1,2,3…）"
        required: false
        default: "2"
      max_depth:             # 5
        description: "最大深さ（0=開始のみ, 1=子 …）"
        required: false
        default: "1"
      max_pages:             # 6
        description: "最大ページ数（総ブレーキ）"
        required: false
        default: "100"
      wait_between_ms:       # 7
        description: "各ページ撮影間の待機ms（SAFEで自動引上げあり）"
        required: false
        default: "1000"
      safe_mode:             # 8
        description: "安全モード（控えめ設定を自動適用） true/false"
        required: false
        default: "true"
      respect_robots:        # 9
        description: "robots.txt を尊重（Disallow / Crawl-delay） true/false"
        required: false
        default: "true"
      publish_target:        # 10
        description: "出力先: artifact（内部配布） | pages（公開）"
        required: false
        default: "artifact"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          npm install --no-audit --no-fund
          npx playwright install --with-deps

      - name: Capture screenshots
        run: npm run capture
        env:
          # 必須/主要入力
          START_URLS:       ${{ inputs.start_urls }}
          DEVICES:          ${{ inputs.devices }}
          FILENAME_MODE:    ${{ inputs.filename_mode }}
          MAX_DEPTH:        ${{ inputs.max_depth }}
          MAX_PAGES:        ${{ inputs.max_pages }}
          WAIT_BETWEEN_MS:  ${{ inputs.wait_between_ms }}
          SAFE_MODE:        ${{ inputs.safe_mode }}
          RESPECT_ROBOTS:   ${{ inputs.respect_robots }}
          PUBLISH_TARGET:   ${{ inputs.publish_target }}
          SCALE:            ${{ inputs.scale }}

          # 既定（変更したければ capture.mjs のデフォルトを編集）
          OUT_DIR:          public
          FULL_PAGE:        "true"           # 必要なら capture.mjs 側で切替可
          # SAME_HOST_ONLY, PATH_PREFIX_MODE, SKIP_URL_PATTERNS,
          # SAMPLE_DETAIL_ALLOW/PATTERNS, MASK_SELECTORS, TIMEOUT/RETRY
          # は capture.mjs のデフォルトが有効になります

      # 出力：artifact（内部配布）
      - name: Upload artifact (public/)
        if: ${{ inputs.publish_target == 'artifact' }}
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: public
          if-no-files-found: warn

      # 出力：GitHub Pages（公開）
      - name: Upload Pages artifact
        if: ${{ inputs.publish_target == 'pages' }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    if: ${{ inputs.publish_target == 'pages' }}
    needs: run
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
